name: quotation-book

networks:
  qb-net:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  rabbitmq-data:
  minio-data:
  pgadmin-data:

services:
  quotation-book-postgres:
    container_name: ${POSTGRES_DB_HOST}
    build:
      context: ../..
      dockerfile: docker/QB.Postgres.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        POSTGRES_BASE_IMAGE: ${POSTGRES_BASE_IMAGE}
    environment:
      POSTGRES_DB: ${POSTGRES_DB_NAME}
      POSTGRES_USER: ${POSTGRES_DB_USER}
      POSTGRES_PASSWORD: ${POSTGRES_DB_PASSWORD}

      POSTGRES_DB_HOST: ${POSTGRES_DB_HOST}
      POSTGRES_DB_NAME: ${POSTGRES_DB_NAME}
      POSTGRES_DB_USER: ${POSTGRES_DB_USER}
      POSTGRES_DB_PASSWORD: ${POSTGRES_DB_PASSWORD}

      KEYCLOAK_DB_NAME: ${KEYCLOAK_DB_NAME:-keycloak}
      KEYCLOAK_DB_USER: ${KEYCLOAK_DB_USER:-keycloak}
      KEYCLOAK_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak_password}

      POSTGRES_CERT_FILE: /opt/postgres/certs/certificate.crt
      POSTGRES_KEY_FILE: /opt/postgres/certs/private.key
      PGDATA: ${PGDATA}
    volumes:
      - postgres-data:${PGDATA}
      - ../../docker/ssl/certs:/opt/postgres/certs:ro
    expose:
      - "${POSTGRES_DB_PORT}"
    entrypoint: ["/init-with-ssl.sh"]
    command: >
      -c ssl=on
      -c ssl_cert_file=/tmp/pgssl/server.crt
      -c ssl_key_file=/tmp/pgssl/server.key
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p ${POSTGRES_DB_PORT} -U ${POSTGRES_DB_USER} -d ${POSTGRES_DB_NAME} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s
    restart: unless-stopped
    networks: [qb-net]

  quotation-book-postgres-migration:
    container_name: quotation-book-postgres-migration
    build:
      context: ../..
      dockerfile: docker/QB.Postgres.Migration.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        DB_MIGRATION_BASE_IMAGE: ${DB_MIGRATION_BASE_IMAGE}
        POSTGRES_DB_CONNECTION_ENCRYPT: ${POSTGRES_DB_CONNECTION_ENCRYPT}
    environment:
      POSTGRES_DB_HOST: ${POSTGRES_DB_HOST}
      POSTGRES_DB_PORT: ${POSTGRES_DB_PORT}
      POSTGRES_DB_NAME: ${POSTGRES_DB_NAME}
      POSTGRES_DB_USER: ${POSTGRES_DB_USER}
      POSTGRES_DB_PASSWORD: ${POSTGRES_DB_PASSWORD}
      POSTGRES_DB_CONNECTION_ENCRYPT: ${POSTGRES_DB_CONNECTION_ENCRYPT}
    depends_on:
      quotation-book-postgres:
        condition: service_healthy
    restart: "no"
    networks: [qb-net]
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 3s
      retries: 1

  quotation-book-redis:
    container_name: ${REDIS_HOST}
    build:
      context: ../..
      dockerfile: docker/QB.Redis.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        REDIS_BASE_IMAGE: ${REDIS_BASE_IMAGE}
    environment:
      REDIS_PASS: ${REDIS_PASS}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PORT_TLS: ${REDIS_PORT_TLS}
    volumes:
      - redis-data:/var/lib/redis
    expose:
      - "${REDIS_PORT}"
      - "${REDIS_PORT_TLS}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "redis-cli -h 127.0.0.1 -p ${REDIS_PORT} -a \"${REDIS_PASS}\" ping 2>/dev/null | grep -q PONG || redis-cli -h 127.0.0.1 -p ${REDIS_PORT} ping | grep -q PONG"
        ]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 10s
    restart: unless-stopped
    networks: [qb-net]

  quotation-book-rabbitmq:
    container_name: ${RABBITMQ_HOST}
    hostname: ${RABBITMQ_HOST}
    build:
      context: ../..
      dockerfile: docker/QB.RabbitMQ.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        RABBITMQ_BASE_IMAGE: ${RABBITMQ_BASE_IMAGE}

    environment:
      RABBITMQ_PORT: ${RABBITMQ_PORT}
      RABBITMQ_PORT_SSL: ${RABBITMQ_PORT_SSL}
      RABBITMQ_MANAGEMENT_PORT: ${RABBITMQ_MANAGEMENT_PORT}
      RABBITMQ_USER: ${RABBITMQ_USER}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST}
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
      ELIXIR_ERL_OPTIONS: "+fnu"

    volumes:
      - rabbitmq-data:/var/lib/rabbitmq/mnesia

    ports:
      - "${RABBITMQ_MANAGEMENT_PORT}:${RABBITMQ_MANAGEMENT_PORT}"
      - "${RABBITMQ_PORT}:${RABBITMQ_PORT}"
      - "${RABBITMQ_PORT_SSL}:${RABBITMQ_PORT_SSL}"

    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/${RABBITMQ_PORT} && echo > /dev/tcp/127.0.0.1/${RABBITMQ_MANAGEMENT_PORT}'"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s

    restart: unless-stopped
    networks: [qb-net]


  quotation-book-minio:
    container_name: quotation-book-minio
    build:
      context: ../..
      dockerfile: docker/QB.Minio.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        MINIO_BASE_IMAGE: ${MINIO_BASE_IMAGE}
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_CERTS_DIR: ${MINIO_CERTS_DIR:-/certs}  # Директория с SSL сертификатами
      MINIO_API_PORT: ${MINIO_API_PORT}
      MINIO_CONSOLE_PORT: ${MINIO_CONSOLE_PORT}
      MINIO_SERVER_URL: https://localhost:${MINIO_API_PORT}  # Для внутреннего использования
    volumes:
      - minio-data:/bitnami/minio/data
    ports:
      - "${MINIO_API_PORT}:${MINIO_API_PORT}"
      - "${MINIO_CONSOLE_PORT}:${MINIO_CONSOLE_PORT}"
    command:
        - minio
        - server
        - /bitnami/minio/data
        - --certs-dir
        - ${MINIO_CERTS_DIR:-/certs}
        - --console-address
        - :${MINIO_CONSOLE_PORT}
        - --address
        - :${MINIO_API_PORT}
    healthcheck:
      test: ["CMD-SHELL", "curl -k https://127.0.0.1:${MINIO_API_PORT}/minio/health/live >/dev/null || curl http://127.0.0.1:${MINIO_API_PORT}/minio/health/live >/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 15s
    restart: unless-stopped
    networks: [qb-net]

  quotation-book-minio-migration:
    container_name: quotation-book-minio-migration
    build:
      context: ../..
      dockerfile: docker/QB.Minio.Migration.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        MINIO_BASE_IMAGE_CLIENT: ${MINIO_BASE_IMAGE_CLIENT}
    environment:
      MINIO_SCHEME: ${MINIO_SCHEME:-https}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_HOST: quotation-book-minio
      MINIO_PORT: ${MINIO_API_PORT:-9000}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-qb-library}
    depends_on:
      quotation-book-minio:
        condition: service_healthy
    restart: "no"
    networks: [qb-net]
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 3s
      retries: 1

  quotation-book-keycloak:
    container_name: quotation-book-keycloak
    build:
      context: ../..
      dockerfile: docker/QB.Keycloak.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        KEYCLOAK_BASE_IMAGE: ${KEYCLOAK_BASE_IMAGE}
        CLIENT_URL: ${CLIENT_URL}

    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}

      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://quotation-book-postgres:5432/keycloak?sslmode=require
      KC_DB_USERNAME: ${KC_DB_USERNAME}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD}

      KC_HTTPS_CERTIFICATE_FILE: /usr/share/java/keycloak/conf/certificate.crt
      KC_HTTPS_CERTIFICATE_KEY_FILE: /usr/share/java/keycloak/conf/private.key

      KC_HTTP_ENABLED: ${KC_HTTP_ENABLED}
      KC_HTTP_PORT: ${KC_HTTP_PORT}
      KC_HTTPS_PORT: ${KC_HTTPS_PORT}
      KC_PROXY: ${KC_PROXY}

      CLIENT_URL: ${CLIENT_URL}
      KC_HOSTNAME: ${KEYCLOAK_EXTERNAL_HOST}
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"

    ports:
      - "${KC_HTTP_PORT}:${KC_HTTP_PORT}"
      - "${KC_HTTPS_PORT}:${KC_HTTPS_PORT}"

    depends_on:
      quotation-book-postgres:
        condition: service_healthy
      quotation-book-postgres-migration:
        condition: service_completed_successfully

    healthcheck:
      test: ["CMD-SHELL", "curl -kfsS https://127.0.0.1:${KC_HTTPS_PORT}/health/ready >/dev/null || curl -kfsS https://127.0.0.1:${KC_HTTPS_PORT}/ >/dev/null"]
      interval: 10s
      timeout: 10s
      retries: 40
      start_period: 30s

    restart: unless-stopped
    networks: [qb-net]

  quotation-book-backend:
    container_name: ${BACKEND_HOST}
    build:
      context: ../..
      dockerfile: docker/QB.Backend.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        PYTHON_BASE_IMAGE: ${PYTHON_BASE_IMAGE}
        PIP_INDEX_URL_PARAM: ${PIP_INDEX_URL_PARAM}
        PIP_TRUSTED_HOST_PARAM: ${PIP_TRUSTED_HOST_PARAM}
        REDOS_REPO_FILE: ${REDOS_REPO_FILE}
    environment:
      BACKEND_HOST: ${BACKEND_HOST}
      BACKEND_PORT: ${BACKEND_PORT}

      DB_HOST: ${POSTGRES_DB_HOST}
      DB_PORT: ${POSTGRES_DB_PORT}

      POSTGRES_DB_HOST: ${POSTGRES_DB_HOST}
      POSTGRES_DB_PORT: ${POSTGRES_DB_PORT}
      POSTGRES_DB_NAME: ${POSTGRES_DB_NAME}
      POSTGRES_DB_USER: ${POSTGRES_DB_USER}
      POSTGRES_DB_PASSWORD: ${POSTGRES_DB_PASSWORD}
      POSTGRES_HOST: ${POSTGRES_DB_HOST}
      POSTGRES_PORT: ${POSTGRES_DB_PORT}

      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PORT_TLS: ${REDIS_PORT_TLS}
      REDIS_PASS: ${REDIS_PASS}

      RABBITMQ_HOST: ${RABBITMQ_HOST}
      RABBITMQ_PORT: ${RABBITMQ_PORT}
      RABBITMQ_PORT_SSL: ${RABBITMQ_PORT_SSL}
      RABBITMQ_MANAGEMENT_PORT: ${RABBITMQ_MANAGEMENT_PORT}
      RABBITMQ_USER: ${RABBITMQ_USER}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST}

      MINIO_API_PORT: ${MINIO_API_PORT}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}

      KC_HTTP_PORT: ${KC_HTTP_PORT}
      CLIENT_URL: ${CLIENT_URL}
    expose:
      - "${BACKEND_PORT}"
    depends_on:
      quotation-book-postgres:
        condition: service_healthy
      quotation-book-postgres-migration:
        condition: service_completed_successfully
      quotation-book-redis:
        condition: service_healthy
      quotation-book-rabbitmq:
        condition: service_healthy
      quotation-book-minio:
        condition: service_healthy
      quotation-book-minio-migration:
        condition: service_completed_successfully
      quotation-book-keycloak:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://127.0.0.1:${BACKEND_PORT}/health >/dev/null || (python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', int('${BACKEND_PORT}'))); s.close()\" )"
        ]
      interval: 10s
      timeout: 10s
      retries: 40
      start_period: 20s
    restart: unless-stopped
    networks: [qb-net]
  
  quotation-book-frontend:
    container_name: ${FRONTEND_HOST}
    build:
      context: ../..
      dockerfile: docker/QB.Frontend.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        FRONTEND_BASE_IMAGE: ${FRONTEND_BASE_IMAGE}
    environment:
      FRONTEND_PORT: ${FRONTEND_PORT}
      BACKEND_HOST: ${BACKEND_HOST}
      BACKEND_PORT: ${BACKEND_PORT}
      KEYCLOAK_HOST: ${KEYCLOAK_HOST}
      KEYCLOAK_PORT: ${KEYCLOAK_PORT}
    ports:
      - "${FRONTEND_PORT}:8443"
    depends_on:
      quotation-book-backend:
        condition: service_healthy
      quotation-book-keycloak:
        condition: service_healthy
      quotation-book-javascript-obs:
        condition: service_healthy
    restart: unless-stopped
    networks: [qb-net]

  quotation-book-pgadmin:
    container_name: quotation-book-pgadmin
    build:
      context: ../..
      dockerfile: docker/QB.pgAdmin.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        PG_ADMIN_BASE_IMAGE: ${PG_ADMIN_BASE_IMAGE}
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PG_ADMIN_USER:-admin@admin.com}
      PGADMIN_DEFAULT_PASSWORD: ${PG_ADMIN_PASSWORD:-admin}
      PGADMIN_LISTEN_PORT: 80
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      quotation-book-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:80/misc/ping >/dev/null || curl -fsS http://127.0.0.1:80/ >/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s
    restart: unless-stopped
    networks: [qb-net]

  quotation-book-java-obs:
    container_name: ${JAVA_HOST}
    build:
      context: ../..
      dockerfile: docker/QB.Java.Obs.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        MAVEN_BASE_IMAGE: ${MAVEN_BASE_IMAGE}
        JDK_BASE_IMAGE: ${JDK_BASE_IMAGE}
        MAVEN_REPO_PARAM: ${MAVEN_REPO_PARAM}
    environment:
      JAVA_OPTS: ${JAVA_OPTS:-}
      MAVEN_REPO_PARAM: ${MAVEN_REPO_PARAM}
    expose:
      - "8443"
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 8443)); s.close()\""]
      interval: 15s
      timeout: 5s
      retries: 30
      start_period: 20s
    restart: unless-stopped
    networks: [qb-net]

  quotation-book-javascript-obs:
    container_name: quotation-book-javascript-obs
    build:
      context: ../..
      dockerfile: docker/QB.Javascript.Obs.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        NODE_BASE_IMAGE: ${NODE_BASE_IMAGE}
        NPM_REGISTRY: ${NPM_REGISTRY:-https://registry.npmjs.org}
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      NPM_REGISTRY: ${NPM_REGISTRY:-https://registry.npmjs.org}
    ports:
    - "3000:3000"
    healthcheck:
      test: ["CMD-SHELL", "curl -kfsS https://127.0.0.1:3000/ >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 30
      start_period: 20s
    restart: unless-stopped
    networks: [qb-net]

  quotation-book-dotnet-obs:
    container_name: ${HEALTH_HOST}
    build:
      context: ../..
      dockerfile: docker/QB.Dotnet.Obs.Dockerfile
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY}
        DOTNET_BASE_IMAGE: ${DOTNET_BASE_IMAGE}
        DOTNET_RUNTIME_IMAGE: ${DOTNET_RUNTIME_IMAGE}
    environment:
      ASPNETCORE_URLS: ${ASPNETCORE_URLS:-http://+:1443}
    expose:
      - "1443"
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 1443)); s.close()\""]
      interval: 15s
      timeout: 5s
      retries: 30
      start_period: 20s
    restart: unless-stopped
    networks: [qb-net]