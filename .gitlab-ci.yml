stages:
  - deploy

deploy_minikube_helm:
  stage: deploy
  image: alpine:latest
  tags:
    - docker-runner

  variables:
    NAMESPACE: demo
    RELEASE: quotation-book
    REMOTE_DIR: /tmp/qb-chart
    VALUES_OVERLAY: values-minikube.yaml

  before_script:
    - apk add --no-cache openssh-client bash gettext curl tar coreutils
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -H "$MINIKUBE_HOST" >> ~/.ssh/known_hosts
    - cp "$QB_ENV_FILE" .env
    - set -a; . ./.env; set +a
    - export TLS_ENABLED="${TLS_ENABLED:-false}"
    - export TLS_CREATE="${TLS_CREATE:-false}"
    - |
      if [ "$TLS_CREATE" = "true" ]; then
        if [ -n "${TLS_CERTIFICATE_CRT_FILE:-}" ] && [ -f "$TLS_CERTIFICATE_CRT_FILE" ]; then
          export TLS_CERTIFICATE_CRT_B64="$(cat "$TLS_CERTIFICATE_CRT_FILE" | base64 | tr -d '\n')"
        fi
        if [ -n "${TLS_PRIVATE_KEY_FILE:-}" ] && [ -f "$TLS_PRIVATE_KEY_FILE" ]; then
          export TLS_PRIVATE_KEY_B64="$(cat "$TLS_PRIVATE_KEY_FILE" | base64 | tr -d '\n')"
        fi
        if [ -n "${TLS_CA_ROOT_CRT_FILE:-}" ] && [ -f "$TLS_CA_ROOT_CRT_FILE" ]; then
          export TLS_CA_ROOT_CRT_B64="$(cat "$TLS_CA_ROOT_CRT_FILE" | base64 | tr -d '\n')"
        fi
      fi
    - |
      if [ -f ./values-from-env.tpl.yaml ]; then
        export VALUES_TPL=./values-from-env.tpl.yaml
      elif [ -f ./ci/values-from-env.tpl.yaml ]; then
        export VALUES_TPL=./ci/values-from-env.tpl.yaml
      else
        find . -maxdepth 3 -type f -name '*from-env*' -print || true
        exit 1
      fi
    - envsubst < "$VALUES_TPL" > /tmp/values-ci.yaml
    - |
      tar -czf /tmp/qb-chart.tgz \
        Chart.yaml \
        values.yaml \
        values-prod.yaml \
        templates \
        ci || tar -czf /tmp/qb-chart.tgz \
          Chart.yaml \
          values.yaml \
          values-prod.yaml \
          templates
    - |
      if [ -f "$VALUES_OVERLAY" ]; then
        cp "$VALUES_OVERLAY" /tmp/values-overlay.yaml
      elif [ -f "./ci/$VALUES_OVERLAY" ]; then
        cp "./ci/$VALUES_OVERLAY" /tmp/values-overlay.yaml
      else
        echo "overlay not found: $VALUES_OVERLAY"
        exit 1
      fi

  script:
    - |
      ssh -i ~/.ssh/id_ed25519 "$MINIKUBE_USER@$MINIKUBE_HOST" 'bash -lc "
        set -e
        kubectl get nodes -o wide
        kubectl get ns '"$NAMESPACE"' >/dev/null 2>&1 || kubectl create ns '"$NAMESPACE"'
        if ! command -v helm >/dev/null 2>&1; then
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        fi
        rm -rf '"$REMOTE_DIR"'
        mkdir -p '"$REMOTE_DIR"'
      "'
    - scp -i ~/.ssh/id_ed25519 /tmp/qb-chart.tgz "$MINIKUBE_USER@$MINIKUBE_HOST:/tmp/qb-chart.tgz"
    - scp -i ~/.ssh/id_ed25519 /tmp/values-ci.yaml "$MINIKUBE_USER@$MINIKUBE_HOST:/tmp/values-ci.yaml"
    - scp -i ~/.ssh/id_ed25519 /tmp/values-overlay.yaml "$MINIKUBE_USER@$MINIKUBE_HOST:/tmp/values-overlay.yaml"
    - |
      ssh -i ~/.ssh/id_ed25519 "$MINIKUBE_USER@$MINIKUBE_HOST" 'bash -lc "
        set -e
        tar -xzf /tmp/qb-chart.tgz -C '"$REMOTE_DIR"'
        helm upgrade --install '"$RELEASE"' '"$REMOTE_DIR"' \
          -n '"$NAMESPACE"' \
          -f /tmp/values-ci.yaml \
          -f /tmp/values-overlay.yaml
        kubectl -n '"$NAMESPACE"' rollout status deploy/quotation-book-frontend --timeout=180s || true
        kubectl -n '"$NAMESPACE"' rollout status deploy/quotation-book-backend  --timeout=180s || true
        kubectl -n '"$NAMESPACE"' get pods,svc -o wide
        echo https://$(minikube ip):30443
      "'
