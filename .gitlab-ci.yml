stages:
  - deploy

deploy_minikube_helm:
  stage: deploy
  image: alpine:latest
  tags:
    - docker-runner
  variables:
    RELEASE: quotation-book
    NAMESPACE: demo
    REMOTE_DIR: /tmp/qb-chart
    VALUES_OVERLAY: values-minikube.yaml
    TIMEOUT_INFRA: 20m
    TIMEOUT_MIGRATIONS: 30m
    TIMEOUT_APPS: 30m
  before_script:
    - apk add --no-cache openssh-client bash gettext curl tar coreutils
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -H "$MINIKUBE_HOST" >> ~/.ssh/known_hosts
    - cp "$QB_ENV_FILE" .env
    - set -a; . ./.env; set +a
    - export DOCKER_REGISTRY="${DOCKER_REGISTRY:-quay.io}"
    - export K8S_NAMESPACE="${K8S_NAMESPACE:-$NAMESPACE}"
    - export TLS_ENABLED="${TLS_ENABLED:-false}"
    - export TLS_CREATE="${TLS_CREATE:-false}"
    - export TLS_SECRET_NAME="$(echo "${TLS_SECRET_NAME:-quotation-book-tls}" | tr '[:upper:]' '[:lower:]')"
    - |
      if [ "$TLS_CREATE" = "true" ]; then
        CERT_SRC="./docker/ssl/certs/certificate.crt"
        KEY_SRC="./docker/ssl/certs/private.key"
        CA_SRC="./docker/certs/sandbox_ca_root.crt"
        test -f "$CERT_SRC" && test -f "$KEY_SRC"
        export TLS_CERTIFICATE_CRT_B64="$(cat "$CERT_SRC" | base64 | tr -d '\n')"
        export TLS_PRIVATE_KEY_B64="$(cat "$KEY_SRC" | base64 | tr -d '\n')"
        if [ -f "$CA_SRC" ]; then export TLS_CA_ROOT_CRT_B64="$(cat "$CA_SRC" | base64 | tr -d '\n')"; else export TLS_CA_ROOT_CRT_B64=""; fi
      else
        export TLS_CERTIFICATE_CRT_B64=""
        export TLS_PRIVATE_KEY_B64=""
        export TLS_CA_ROOT_CRT_B64=""
      fi
    - export VALUES_TPL="./ci/values-from-env.tpl.yaml"
    - envsubst < "$VALUES_TPL" > /tmp/values-ci.yaml
    - cp "$VALUES_OVERLAY" /tmp/values-overlay.yaml
    - |
      tar -czf /tmp/qb-chart.tgz \
        Chart.yaml \
        values.yaml \
        values-prod.yaml \
        values-minikube.yaml \
        templates \
        docker \
        ci
  script:
    - |
      ssh -i ~/.ssh/id_ed25519 "$MINIKUBE_USER@$MINIKUBE_HOST" 'bash -lc "
        set -e
        kubectl get nodes -o wide
        kubectl get ns '$NAMESPACE' >/dev/null 2>&1 || kubectl create ns '$NAMESPACE'
        if ! command -v helm >/dev/null 2>&1; then
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        fi
        rm -rf '$REMOTE_DIR'
        mkdir -p '$REMOTE_DIR'
      "'
    - scp -i ~/.ssh/id_ed25519 /tmp/qb-chart.tgz "$MINIKUBE_USER@$MINIKUBE_HOST:/tmp/qb-chart.tgz"
    - scp -i ~/.ssh/id_ed25519 /tmp/values-ci.yaml "$MINIKUBE_USER@$MINIKUBE_HOST:/tmp/values-ci.yaml"
    - scp -i ~/.ssh/id_ed25519 /tmp/values-overlay.yaml "$MINIKUBE_USER@$MINIKUBE_HOST:/tmp/values-overlay.yaml"
    - |
      ssh -i ~/.ssh/id_ed25519 "$MINIKUBE_USER@$MINIKUBE_HOST" 'bash -lc "
        set -e
        tar -xzf /tmp/qb-chart.tgz -C '$REMOTE_DIR'

        helm upgrade --install '$RELEASE' '$REMOTE_DIR' \
          -n '$NAMESPACE' \
          -f /tmp/values-ci.yaml \
          -f /tmp/values-overlay.yaml \
          --set namespace.create=false \
          --set namespace.name='$NAMESPACE' \
          --set tls.enabled='$TLS_ENABLED' \
          --set tls.create='$TLS_CREATE' \
          --set tls.name='$TLS_SECRET_NAME' \
          --set tls.secretName='$TLS_SECRET_NAME' \
          --timeout '$TIMEOUT_INFRA' \
          --wait

        helm upgrade '$RELEASE' '$REMOTE_DIR' \
          -n '$NAMESPACE' \
          -f /tmp/values-ci.yaml \
          -f /tmp/values-overlay.yaml \
          --set tls.enabled='$TLS_ENABLED' \
          --set tls.create='$TLS_CREATE' \
          --set tls.name='$TLS_SECRET_NAME' \
          --set tls.secretName='$TLS_SECRET_NAME' \
          --set postgres.enabled=true \
          --set redis.enabled=true \
          --set rabbitmq.enabled=true \
          --timeout '$TIMEOUT_INFRA' \
          --wait

        kubectl -n '$NAMESPACE' wait --for=condition=Ready pod -l app.kubernetes.io/instance='$RELEASE',app.kubernetes.io/name=postgres --timeout=10m
        kubectl -n '$NAMESPACE' wait --for=condition=Ready pod -l app.kubernetes.io/instance='$RELEASE',app.kubernetes.io/name=redis --timeout=10m
        kubectl -n '$NAMESPACE' wait --for=condition=Ready pod -l app.kubernetes.io/instance='$RELEASE',app.kubernetes.io/name=rabbitmq --timeout=10m

        helm upgrade '$RELEASE' '$REMOTE_DIR' \
          -n '$NAMESPACE' \
          -f /tmp/values-ci.yaml \
          -f /tmp/values-overlay.yaml \
          --set tls.enabled='$TLS_ENABLED' \
          --set tls.create='$TLS_CREATE' \
          --set tls.name='$TLS_SECRET_NAME' \
          --set tls.secretName='$TLS_SECRET_NAME' \
          --set postgres.enabled=true \
          --set postgresMigration.enabled=true \
          --set redis.enabled=true \
          --set rabbitmq.enabled=true \
          --timeout '$TIMEOUT_MIGRATIONS' \
          --wait

        helm upgrade '$RELEASE' '$REMOTE_DIR' \
          -n '$NAMESPACE' \
          -f /tmp/values-ci.yaml \
          -f /tmp/values-overlay.yaml \
          --set tls.enabled='$TLS_ENABLED' \
          --set tls.create='$TLS_CREATE' \
          --set tls.name='$TLS_SECRET_NAME' \
          --set tls.secretName='$TLS_SECRET_NAME' \
          --set postgres.enabled=true \
          --set postgresMigration.enabled=true \
          --set redis.enabled=true \
          --set rabbitmq.enabled=true \
          --set minio.enabled=true \
          --timeout '$TIMEOUT_INFRA' \
          --wait

        kubectl -n '$NAMESPACE' wait --for=condition=Ready pod -l app.kubernetes.io/instance='$RELEASE',app.kubernetes.io/name=minio --timeout=10m

        helm upgrade '$RELEASE' '$REMOTE_DIR' \
          -n '$NAMESPACE' \
          -f /tmp/values-ci.yaml \
          -f /tmp/values-overlay.yaml \
          --set tls.enabled='$TLS_ENABLED' \
          --set tls.create='$TLS_CREATE' \
          --set tls.name='$TLS_SECRET_NAME' \
          --set tls.secretName='$TLS_SECRET_NAME' \
          --set postgres.enabled=true \
          --set postgresMigration.enabled=true \
          --set redis.enabled=true \
          --set rabbitmq.enabled=true \
          --set minio.enabled=true \
          --set minioMigration.enabled=true \
          --timeout '$TIMEOUT_MIGRATIONS' \
          --wait

        helm upgrade '$RELEASE' '$REMOTE_DIR' \
          -n '$NAMESPACE' \
          -f /tmp/values-ci.yaml \
          -f /tmp/values-overlay.yaml \
          --set tls.enabled='$TLS_ENABLED' \
          --set tls.create='$TLS_CREATE' \
          --set tls.name='$TLS_SECRET_NAME' \
          --set tls.secretName='$TLS_SECRET_NAME' \
          --set postgres.enabled=true \
          --set postgresMigration.enabled=true \
          --set redis.enabled=true \
          --set rabbitmq.enabled=true \
          --set minio.enabled=true \
          --set minioMigration.enabled=true \
          --set keycloak.enabled=true \
          --timeout '$TIMEOUT_APPS' \
          --wait

        kubectl -n '$NAMESPACE' wait --for=condition=Ready pod -l app.kubernetes.io/instance='$RELEASE',app.kubernetes.io/name=keycloak --timeout=15m

        helm upgrade '$RELEASE' '$REMOTE_DIR' \
          -n '$NAMESPACE' \
          -f /tmp/values-ci.yaml \
          -f /tmp/values-overlay.yaml \
          --set tls.enabled='$TLS_ENABLED' \
          --set tls.create='$TLS_CREATE' \
          --set tls.name='$TLS_SECRET_NAME' \
          --set tls.secretName='$TLS_SECRET_NAME' \
          --set postgres.enabled=true \
          --set postgresMigration.enabled=true \
          --set redis.enabled=true \
          --set rabbitmq.enabled=true \
          --set minio.enabled=true \
          --set minioMigration.enabled=true \
          --set keycloak.enabled=true \
          --set backend.enabled=true \
          --timeout '$TIMEOUT_APPS' \
          --wait

        kubectl -n '$NAMESPACE' rollout status deploy/'$RELEASE'-backend --timeout=15m

        helm upgrade '$RELEASE' '$REMOTE_DIR' \
          -n '$NAMESPACE' \
          -f /tmp/values-ci.yaml \
          -f /tmp/values-overlay.yaml \
          --set tls.enabled='$TLS_ENABLED' \
          --set tls.create='$TLS_CREATE' \
          --set tls.name='$TLS_SECRET_NAME' \
          --set tls.secretName='$TLS_SECRET_NAME' \
          --set postgres.enabled=true \
          --set postgresMigration.enabled=true \
          --set redis.enabled=true \
          --set rabbitmq.enabled=true \
          --set minio.enabled=true \
          --set minioMigration.enabled=true \
          --set keycloak.enabled=true \
          --set backend.enabled=true \
          --set frontend.enabled=true \
          --timeout '$TIMEOUT_APPS' \
          --wait

        kubectl -n '$NAMESPACE' rollout status deploy/'$RELEASE'-frontend --timeout=15m

        kubectl -n '$NAMESPACE' get pods,svc -o wide
        echo https://$(minikube ip):30443
      "'
