stages: [deploy]

deploy_minikube:
  stage: deploy
  image: alpine:latest
  tags: [docker-runner]
  timeout: 60m
  variables:
    RELEASE: quotation-book
    NAMESPACE: demo
    REMOTE_DIR: /tmp/qb-chart
    VALUES_OVERLAY: values-minikube.yaml
  before_script:
    - apk add --no-cache bash openssh-client curl tar coreutils gettext
    - mkdir -p ~/.ssh
    - |
      if echo "$SSH_PRIVATE_KEY" | grep -q "BEGIN"; then
        printf '%s\n' "$SSH_PRIVATE_KEY" | sed 's/\r$//' > ~/.ssh/id_ed25519
      else
        echo "$SSH_PRIVATE_KEY" | tr -d '\r\n' | base64 -d > ~/.ssh/id_ed25519
      fi
    - chmod 600 ~/.ssh/id_ed25519
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/id_ed25519
    - ssh-keyscan -H "$MINIKUBE_HOST" >> ~/.ssh/known_hosts
  script:
    - chmod +x ci/deploy-minikube.sh
    - ci/deploy-minikube.sh
